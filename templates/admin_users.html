{% extends "base.html" %}
{% block body %}

<style>
    .user-container {
        max-width: 1000px;
        margin: 80px auto;
        color: white;
        animation: fadeUp 0.7s ease forwards;
        opacity: 0;
        transform: translateY(30px);
    }

    @keyframes fadeUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .user-table {
        width: 100%;
        background: rgba(0, 0, 0, 0.55);
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 0 25px rgba(0, 0, 0, 0.4);
    }

    .user-table th,
    .user-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.15);
    }

    .user-table th {
        color: #ffd27f;
        font-weight: 600;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 600;
    }

    .status-online {
        background: rgba(39, 255, 126, 0.15);
        color: #27ff7e;
        box-shadow: 0 0 10px #27ff7e;
    }

    .status-offline {
        background: rgba(255, 80, 80, 0.15);
        color: #ff6464;
    }

    .btn-sm {
        font-size: 13px !important;
        padding: 3px 8px !important;
    }

    @media(max-width: 700px) {

        .user-table th,
        .user-table td {
            font-size: 13px;
            padding: 8px;
        }
    }
</style>

<div class="user-container">
    <h2 class="text-center mb-4">ðŸ‘¥ All Registered Users</h2>

    <table class="user-table" id="user-table">
        <thead>
            <tr>
                <th>Email</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for u in users %}
            <tr>
                <td>{{ u.email }}</td>
                <td>
                    {% if u.is_online %}
                    <span class="status-badge status-online">ðŸŸ¢ Online</span>
                    {% else %}
                    <span class="status-badge status-offline">ðŸ”´ Offline</span>
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('admin_user_profile', email=u.email) }}" class="btn btn-primary btn-sm">Open</a>
                    {% if not u.get('blocked') %}
                    <form action="{{ url_for('admin_block_user', email=u.email) }}" method="POST"
                        style="display:inline;">
                        <button class="btn btn-danger btn-sm">Block</button>
                    </form>
                    {% else %}
                    <form action="{{ url_for('admin_unblock_user', email=u.email) }}" method="POST"
                        style="display:inline;">
                        <button class="btn btn-success btn-sm">Unblock</button>
                    </form>
                    <span style="color:red;font-weight:bold;">(Blocked)</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    function refreshUserStatuses() {
        fetch("/admin/live_users_json")
            .then(res => res.json())
            .then(data => {
                if (data.error) return;
                const rows = document.querySelectorAll("#user-table tbody tr");
                data.forEach(u => {
                    const row = Array.from(rows).find(r => r.cells[0].textContent.trim() === u.email);
                    if (!row) return;
                    const statusCell = row.cells[1];
                    statusCell.innerHTML = u.is_online ?
                        '<span class="status-badge status-online">ðŸŸ¢ Online</span>' :
                        '<span class="status-badge status-offline">ðŸ”´ Offline</span>';
                });
            })
            .catch(() => { });
    }
    setInterval(refreshUserStatuses, 5000);
    window.addEventListener("load", refreshUserStatuses);
</script>

{% endblock %}